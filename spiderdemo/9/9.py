import base64

import requests
import re
from io import BytesIO
from PIL import Image
import ddddocr
cookies = {
    'sessionid': '',
}

headers = {
    'accept': 'application/json, text/javascript, */*; q=0.01',
    'accept-language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
    'cache-control': 'no-cache',
    'pragma': 'no-cache',
    'priority': 'u=1, i',
    'referer': 'https://www.spiderdemo.cn/font_anti/font_sprites_challenge/?challenge_type=font_sprites_challenge',
    'sec-ch-ua': '"Microsoft Edge";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'same-origin',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36 Edg/141.0.0.0',
    'x-requested-with': 'XMLHttpRequest',
}

params = {
    'challenge_type': 'font_sprites_challenge',
}


def getnums(data):
    # ================== 提取 class 对应偏移 ==================
    css_text = data["css_code"]
    pattern = re.compile(r"\.(class\d+)\{background-position:\s*(-?\d+)px\s+0;")
    class_to_x = {m[0]: int(m[1]) for m in pattern.findall(css_text)}

    # ================== 解析 page_data ==================
    page_data = data["page_data"]
    pages_class = []
    for row in page_data:
        classes = re.findall(r"class\d+", row)
        pages_class.append(classes)

    # ================== 解码雪碧图 ==================
    sprite_img = Image.open(BytesIO(base64.b64decode(data["sprite"])))
    sprite_width, sprite_height = sprite_img.size

    # 计算每个小字符的宽度
    widths = sorted(set(class_to_x.values()))
    char_width = min([abs(j - i) for i, j in zip(widths, widths[1:])])
    char_height = sprite_height

    # ================== OCR ==================
    ocr = ddddocr.DdddOcr(det=False, ocr=True)
    class_to_char = {}
    for cls, x in class_to_x.items():
        x = -x  # 注意这里取负
        crop = sprite_img.crop((x, 0, x + 50, sprite_height))  # 假设每个字符宽50
        crop = crop.convert("L").point(lambda p: 0 if p < 128 else 255)
        res = ocr.classification(crop)
        print(cls, res)  # 打印看看识别结果
        class_to_char[cls] = res

    # ================== 拼接结果 ==================
    result = []
    for row in pages_class:
        row_chars = [class_to_char[cls] for cls in row]
        result.append("".join(row_chars))
    allnums=[]
    # 打印结果
    for r in result:
        # print(r)
        allnums.append(r)
    print(allnums)
    return allnums


alldata=[]
for i in range(1,101):
    response = requests.get(
        f'https://www.spiderdemo.cn/font_anti/api/font_sprites_challenge/page/{str(i)}/',
        params=params,
        cookies=cookies,
        headers=headers,
    )
    data=response.json()
    datas=getnums(data)
    alldata.extend(datas)
print(alldata)
# alldata=['7619', '3871', '8102', '9966', '2481', '6893', '7913', '4691', '9399', '8613', '6276', '3730', '1486', '8029', '1709', '4792', '8289', '5563', '8681', '4619', '6209', '3949', '4949', '3275', '5338', '2590', '3749', '9748', '8466', '6249', '6226', '7052', '4593', '9828', '6061', '9868', '1488', '5726', '9366', '6511', '7911', '7012', '8628', '5776', '7195', '7225', '4522', '8414', '3557', '9003', '4283', '6689', '2298', '7359', '8577', '3746', '2295', '2210', '2869', '7206', '9684', '9052', '4126', '8567', '9924', '1598', '9997', '4483', '5877', '4964', '5586', '2374', '2656', '1341', '2250', '6633', '2949', '9081', '7069', '4817', '5085', '9940', '4231', '9281', '4375', '7526', '6977', '1022', '8504', '3333', '1492', '6837', '2354', '3344', '2080', '4890', '2613', '1308', '4779', '5842', '5409', '2328', '5529', '7133', '8626', '4275', '9819', '1405', '5463', '9531', '5362', '5674', '4308', '2647', '7751', '6086', '3977', '4356', '3877', '2472', '8216', '3887', '2366', '6911', '5328', '3961', '9864', '4936', '5383', '7519', '7601', '7913', '9236', '1283', '7034', '1315', '2373', '9642', '1236', '9894', '6771', '4741', '4663', '2406', '3505', '3853', '3532', '1935', '9650', '2108', '8512', '7167', '7646', '9361', '9872', '8261', '6159', '4832', '8909', '9714', '6594', '3697', '8498', '3434', '1199', '2410', '5242', '1887', '3035', '7142', '8631', '4780', '7895', '6866', '4062', '7724', '2543', '5508', '8669', '1665', '7647', '4397', '5311', '3382', '1004', '8632', '7013', '6503', '6325', '2169', '4676', '1011', '3696', '3640', '7634', '5265', '7335', '1417', '9409', '4944', '8083', '7349', '3678', '5009', '2374', '1388', '4316', '2997', '5417', '3539', '9710', '4309', '6259', '4892', '3331', '4248', '9861', '9686', '1177', '1809', '1844', '9924', '3597', '7121', '8297', '7816', '9240', '5217', '5917', '5827', '8102', '4302', '3877', '4681', '1534', '7394', '9145', '6684', '4251', '3720', '7290', '3680', '8512', '5800', '8781', '4674', '4488', '2489', '7953', '7320', '9671', '5252', '4693', '3913', '5606', '6275', '3812', '1921', '9834', '1172', '2302', '1383', '1989', '1049', '6478', '3859', '8877', '5044', '4602', '2780', '3493', '9116', '1525', '3649', '3410', '8668', '1065', '8219', '4800', '7799', '1272', '5415', '6051', '3337', '4032', '3712', '3323', '1205', '8830', '6642', '8357', '8554', '2549', '8461', '3112', '9441', '3138', '3436', '5372', '6901', '4750', '3254', '4604', '2881', '9465', '6506', '9202', '1457', '7186', '9086', '7957', '9702', '7660', '2892', '2306', '4204', '9974', '8037', '1262', '3875', '2466', '7321', '6128', '1475', '9531', '5470', '2625', '5372', '6722', '6448', '1560', '6088', '3064', '2595', '8581', '7114', '7876', '1320', '3134', '4189', '6988', '2125', '2850', '8039', '5147', '3966', '6528', '3020', '4052', '1036', '8078', '4241', '8808', '8146', '6164', '6550', '7416', '9383', '4930', '3231', '6321', '5828', '5893', '3051', '4156', '5495', '5627', '5941', '5618', '2387', '4161', '8708', '5087', '7104', '3616', '2546', '7184', '5504', '8817', '3164', '9173', '1355', '8248', '3892', '6059', '1917', '5338', '2196', '6147', '7457', '6664', '8320', '9784', '9241', '5906', '3783', '1383', '6654', '9110', '5429', '4993', '9091', '1295', '8452', '3866', '6873', '5885', '2582', '2571', '4226', '6484', '7586', '1375', '7057', '8781', '4975', '3610', '8890', '4490', '4590', '4787', '6515', '2985', '1037', '4814', '8290', '7658', '9728', '3049', '1969', '6872', '6177', '6924', '6135', '7822', '5075', '4340', '5481', '2864', '4135', '9797', '7015', '3973', '8135', '9028', '5329', '1342', '1149', '6619', '8661', '4631', '5103', '7176', '3742', '9308', '7096', '2262', '7540', '9659', '2231', '8777', '4739', '4292', '8693', '9360', '7906', '7034', '2410', '6727', '8301', '5942', '1031', '4167', '8983', '6569', '1122', '7485', '6622', '8292', '3784', '5244', '2589', '9420', '2833', '5899', '8934', '9663', '9047', '1064', '9798', '3929', '5716', '7577', '4088', '2092', '3327', '5024', '7204', '3962', '5722', '1437', '7736', '7647', '4346', '1866', '5161', '1104', '7625', '9327', '5326', '7438', '2672', '5957', '7431', '8975', '7617', '9367', '1338', '8918', '2243', '1859', '9104', '2039', '9289', '1522', '4825', '4430', '8084', '1979', '7417', '2104', '8438', '1705', '2794', '4824', '3002', '4159', '9806', '2401', '6027', '9404', '4750', '7540', '2231', '3154', '2991', '1367', '7495', '2209', '4773', '8366', '5404', '2076', '1714', '1916', '9700', '6538', '4387', '9169', '8000', '8360', '6074', '4394', '1905', '3292', '3178', '5196', '1055', '9428', '2705', '3783', '9893', '9101', '6349', '4416', '4772', '7676', '4711', '4995', '9598', '9907', '1342', '3085', '3124', '9936', '8838', '5203', '5532', '9162', '2210', '9873', '8704', '3256', '5793', '8716', '5597', '5542', '8870', '6423', '6895', '2358', '7542', '3073', '6090', '6292', '1158', '9674', '1590', '8001', '6756', '7031', '2026', '1249', '1916', '8758', '5974', '1147', '2885', '2883', '1346', '4337', '9908', '4313', '1909', '8165', '8427', '1554', '9888', '7366', '7556', '4219', '7105', '5495', '7132', '6618', '7844', '6508', '3375', '7628', '6771', '8138', '6265', '9284', '3133', '7177', '1539', '6182', '6693', '6605', '1482', '4959', '2218', '4017', '6069', '4699', '6551', '7918', '3558', '9838', '7535', '1009', '6184', '5493', '6043', '7829', '9742', '7185', '8199', '6615', '8919', '7716', '2175', '7069', '9303', '7940', '8014', '1279', '8263', '2437', '9710', '6828', '2120', '6258', '7119', '3878', '5197', '7602', '5613', '4837', '3156', '2039', '7079', '1809', '1109', '7470', '2793', '5180', '6865', '2308', '3579', '1964', '6480', '8057', '7495', '2615', '1854', '5401', '8192', '6211', '8262', '5795', '2291', '9418', '1992', '1951', '8486', '2502', '8690', '8948', '2011', '4942', '6792', '6416', '2721', '5124', '2771', '9541', '8842', '7243', '2509', '8747', '7293', '3816', '3984', '6226', '2154', '4870', '5988', '7127', '6142', '3915', '1841', '9224', '6124', '6632', '5055', '8390', '6640', '6890', '8849', '4709', '1726', '5062', '6189', '9534', '6423', '3015', '4074', '8929', '8979', '6031', '6714', '9877', '3364', '6376', '4254', '9329', '1136', '6895', '1436', '9917', '9380', '2262', '7577', '9379', '9182', '8293', '5035', '7340', '4455', '3669', '1393', '3680', '1297', '9445', '9587', '9368', '9524', '6155', '1043', '3768', '1431', '4401', '5859', '4130', '8356', '6753', '3921', '8639', '6700', '9106', '2778', '6470', '8386', '9817', '2964', '9377', '9002', '9664', '3754', '5926', '8093', '5586', '9714', '2716', '9420', '1712', '6065', '1016', '6170', '4713', '3757', '1062', '9040', '5474', '6418', '8943', '4158', '3081', '1071', '7315', '8535', '2738', '9950', '1243', '7997', '3974', '9532', '5467', '7059', '2939', '5620', '9572', '9998', '7883', '6547', '8456', '5727', '1227', '7387', '7194', '4778', '4975', '1451', '7124', '7631', '2900', '6275', '2100', '2606', '2251', '9172', '3484', '2341', '9125', '4501', '6286', '5015', '6942', '1579', '9699', '7526', '9125', '8650', '6875', '8942', '1295', '5799', '5985', '7529', '3621', '1749', '6852', '7314', '3585', '7480', '2730', '5990', '5936', '4110', '9133', '6412', '7952', '2753', '2379', '7803', '6926', '7776', '7951', '2732', '6234', '8773', '2314', '2431', '4285', '3246', '4822', '1340', '9055', '8823', '7634', '3685', '4790', '5888', '7636', '4487', '6790', '1147', '9509', '7248', '9141', '7046', '6482', '9827', '6894', '3380', '4743', '2685', '5709', '3745', '9369', '2926', '1237', '6909', '8093', '7438', '3406', '8820', '1480', '2560', '9782', '7875', '4476', '3416', '9388', '5554', '2375', '2962', '1007', '2454', '9801', '7262', '2946', '3107', '4465', '5004', '4464', '1710', '4942', '6066', '1074', '6699', '6320', '7798', '9122', '8908', '1051', '1203', '6968', '7295', '7330', '5858', '1433', '3492', '6976', '9989', '5036', '1616', '5578', '7472', '5265', '5565', '4830', '9388', '1792', '5424', '7128', '3609', '9654', '2121', '3209', '9965', '1963', '6744', '5012', '6700', '4520', '4519', '4895', '4517']

k=0
for i in alldata:
    k=k+int(i)
print(k)
